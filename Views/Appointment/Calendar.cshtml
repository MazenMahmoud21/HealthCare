@model IEnumerable<HealthcareSystem.Models.Appointment>
@{
    ViewData["Title"] = "Appointment Calendar";
    var role = Context.Session.GetString("Role");
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="text-info mb-0"><i class="bi bi-calendar3 me-2"></i>Appointment Calendar</h2>
            <p class="text-muted mb-0">View appointments in calendar format</p>
        </div>
        <div>
            <a asp-action="Index" class="btn btn-outline-primary me-2">
                <i class="bi bi-list me-2"></i>List View
            </a>
            <a asp-action="Create" class="btn btn-info">
                <i class="bi bi-calendar-plus me-2"></i>New Appointment
            </a>
        </div>
    </div>

    <!-- Month Navigation -->
    @{
        var currentMonth = ViewBag.CurrentMonth ?? DateTime.Today;
        var prevMonth = ((DateTime)currentMonth).AddMonths(-1);
        var nextMonth = ((DateTime)currentMonth).AddMonths(1);
    }
    <div class="card mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <a asp-action="Calendar" asp-route-month="@prevMonth.Month" asp-route-year="@prevMonth.Year" 
                   class="btn btn-outline-secondary">
                    <i class="bi bi-chevron-left me-1"></i>Previous
                </a>
                <h3 class="mb-0">@((DateTime)currentMonth).ToString("MMMM yyyy")</h3>
                <a asp-action="Calendar" asp-route-month="@nextMonth.Month" asp-route-year="@nextMonth.Year" 
                   class="btn btn-outline-secondary">
                    Next<i class="bi bi-chevron-right ms-1"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- Calendar Grid -->
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered mb-0 calendar-table">
                    <thead class="table-light">
                        <tr>
                            <th class="text-center" style="width: 14.28%;">Sunday</th>
                            <th class="text-center" style="width: 14.28%;">Monday</th>
                            <th class="text-center" style="width: 14.28%;">Tuesday</th>
                            <th class="text-center" style="width: 14.28%;">Wednesday</th>
                            <th class="text-center" style="width: 14.28%;">Thursday</th>
                            <th class="text-center" style="width: 14.28%;">Friday</th>
                            <th class="text-center" style="width: 14.28%;">Saturday</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            var firstDay = new DateTime(((DateTime)currentMonth).Year, ((DateTime)currentMonth).Month, 1);
                            var lastDay = firstDay.AddMonths(1).AddDays(-1);
                            var startDate = firstDay.AddDays(-(int)firstDay.DayOfWeek);
                            var appointments = Model?.ToList() ?? new List<HealthcareSystem.Models.Appointment>();
                            var today = DateTime.Today;
                        }

                        @for (var week = 0; week < 6; week++)
                        {
                            <tr>
                                @for (var day = 0; day < 7; day++)
                                {
                                    var currentDate = startDate.AddDays(week * 7 + day);
                                    var isCurrentMonth = currentDate.Month == ((DateTime)currentMonth).Month;
                                    var isToday = currentDate.Date == today;
                                    var dayAppointments = appointments.Where(a => a.AppointmentDate.Date == currentDate.Date).ToList();

                                    var cellClass = "";
                                    if (!isCurrentMonth) cellClass = "text-muted bg-light";
                                    if (isToday) cellClass = "bg-info bg-opacity-10 border-info";

                                    <td class="@cellClass calendar-cell">
                                        <div class="calendar-day">
                                            <span class="day-number @(isToday ? "badge bg-info" : "")">@currentDate.Day</span>
                                            @if (dayAppointments.Any() && isCurrentMonth)
                                            {
                                                <div class="appointments-list mt-2">
                                                    @foreach (var apt in dayAppointments.Take(3))
                                                    {
                                                        var aptClass = apt.Status switch
                                                        {
                                                            "Scheduled" => "bg-warning text-dark",
                                                            "Completed" => "bg-success text-white",
                                                            "Cancelled" => "bg-danger text-white",
                                                            _ => "bg-secondary text-white"
                                                        };
                                                        <a asp-action="Details" asp-route-id="@apt.Id" 
                                                           class="d-block small text-decoration-none mb-1 rounded px-1 @aptClass"
                                                           title="@apt.Patient?.FirstName @apt.Patient?.LastName - @apt.AppointmentDate.ToString("HH:mm")">
                                                            @apt.AppointmentDate.ToString("HH:mm") - @(apt.Patient?.FirstName?.Substring(0, 1))@(apt.Patient?.LastName?.Substring(0, 1))
                                                        </a>
                                                    }
                                                    @if (dayAppointments.Count > 3)
                                                    {
                                                        <small class="text-muted">+@(dayAppointments.Count - 3) more</small>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    </td>
                                }
                            </tr>

                            @if (startDate.AddDays((week + 1) * 7) > lastDay && week >= 3)
                            {
                                break;
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Legend -->
    <div class="card mt-4">
        <div class="card-body">
            <h6 class="mb-3">Legend</h6>
            <div class="d-flex gap-4 flex-wrap">
                <div>
                    <span class="badge bg-warning text-dark me-1">●</span>
                    <small>Scheduled</small>
                </div>
                <div>
                    <span class="badge bg-success me-1">●</span>
                    <small>Completed</small>
                </div>
                <div>
                    <span class="badge bg-danger me-1">●</span>
                    <small>Cancelled</small>
                </div>
                <div>
                    <span class="badge bg-info me-1">●</span>
                    <small>Today</small>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .calendar-table {
        table-layout: fixed;
    }
    
    .calendar-cell {
        height: 120px;
        vertical-align: top;
        padding: 8px !important;
    }
    
    .calendar-day {
        height: 100%;
    }
    
    .day-number {
        font-weight: bold;
    }
    
    .appointments-list {
        font-size: 0.75rem;
        max-height: 80px;
        overflow-y: auto;
    }
    
    .appointments-list a:hover {
        opacity: 0.8;
    }
</style>
